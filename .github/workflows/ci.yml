name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  # --- ETAPA 1: PRUEBAS (CI) ---
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Descargar c칩digo
      uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4' # Usamos 8.4 para compatibilidad
        extensions: mbstring, xml, bcmath, sqlite3

    - name: Instalar Dependencias
      run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

    - name: Copiar .env
      run: cp .env.example .env

    - name: Generar Key
      run: php artisan key:generate

    - name: Crear Base de Datos
      run: |
        touch database/database.sqlite
        php artisan migrate --force

    - name: Ejecutar Pruebas
      env:
        DB_CONNECTION: sqlite
        DB_DATABASE: database/database.sqlite
      run: php artisan test

  # --- ETAPA 2: CONSTRUIR Y SUBIR (Build & Push) ---
  build:
    needs: test # Solo se ejecuta si las pruebas pasan
    runs-on: ubuntu-latest
    steps:
      - name: Descargar c칩digo
        uses: actions/checkout@v4

      - name: Login en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Construir Imagen Docker
        # Usa tu usuario autom치ticamente desde los secretos
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/api-laravel:latest .

      - name: Escaneo de Seguridad (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.DOCKER_USERNAME }}/api-laravel:latest'
          format: 'table'
          exit-code: '1' # Falla si hay vulnerabilidades cr칤ticas
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Subir a Docker Hub
        run: docker push ${{ secrets.DOCKER_USERNAME }}/api-laravel:latest

  # --- ETAPA 3: DESPLIEGUE AUTOM츼TICO (CD) ---
  deploy:
    name: "游 Desplegar en VM con Ansible"
    needs: build  # Solo se ejecuta si build pasa
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Solo en main
    
    steps:
      - name: 游닌 Descargar repositorio de infraestructura
        uses: actions/checkout@v4
        with:
          repository: EliasRuizAncao/infraestructura-laravel-proyecto
          token: ${{ secrets.GITHUB_TOKEN }}
          path: infra

      - name: 游댢 Instalar Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible

      - name: 游댐 Configurar acceso SSH a la VM
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: 游 Ejecutar Playbook de Ansible
        run: |
          cd infra
          ansible-playbook -i "${{ secrets.VM_HOST }}," -u ${{ secrets.VM_USER }} deploy.yml
